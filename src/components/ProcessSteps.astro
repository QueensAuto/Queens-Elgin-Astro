---
/**
 * ProcessSteps - Vertical timeline with IntersectionObserver
 * Replicated from Queens Algonquin to avoid pinning conflicts
 */
import CtaButton from "./CtaButton.astro";
---

<section class="process-section" id="process-section">
    <!-- Header -->
    <div class="process-header site-canvas">
        <span class="process-badge">â€” HOW IT WORKS</span>
        <h2 class="process-title display-xl">
            YOUR SERVICE<br />
            <span class="title-accent">EXPERIENCE</span>
        </h2>
        <p class="process-subtitle">
            From the moment you contact us to when you drive away, we make every
            step simple, transparent, and stress-free.
        </p>
    </div>

    <!-- Timeline Items -->
    <div class="timeline-container site-canvas">
        <div class="timeline-item" data-step="1">
            <div class="timeline-marker">
                <div class="timeline-dot">01</div>
                <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
                <h3 class="step-title">Schedule Your Service</h3>
                <p class="step-desc">
                    Book your appointment <span class="text-accent">online</span
                    >
                    or give us a call. Choose the service you need and pick a time
                    that works for your schedule.
                    <span class="text-accent">Same-day appointments</span> often available.
                </p>
            </div>
        </div>

        <div class="timeline-item" data-step="2">
            <div class="timeline-marker">
                <div class="timeline-dot">02</div>
                <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
                <h3 class="step-title">Vehicle Inspection</h3>
                <p class="step-desc">
                    Our <span class="text-accent">certified technicians</span> perform
                    a thorough diagnostic of your vehicle. We identify exactly what
                    needs attention and document everything with <span
                        class="text-accent">photos and video</span
                    >.
                </p>
            </div>
        </div>

        <div class="timeline-item" data-step="3">
            <div class="timeline-marker">
                <div class="timeline-dot">03</div>
                <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
                <h3 class="step-title">Transparent Quote</h3>
                <p class="step-desc">
                    Receive a <span class="text-accent">detailed estimate</span> with
                    no hidden fees. We explain every repair, show you the parts needed,
                    and get your
                    <span class="text-accent"
                        >approval before any work begins</span
                    >.
                </p>
            </div>
        </div>

        <div class="timeline-item" data-step="4">
            <div class="timeline-marker">
                <div class="timeline-dot">04</div>
                <div class="timeline-line"></div>
            </div>
            <div class="timeline-content">
                <h3 class="step-title">Expert Repair</h3>
                <p class="step-desc">
                    Skilled mechanics complete your repairs using <span
                        class="text-accent">quality parts</span
                    >. Every job is backed by our <span class="text-accent"
                        >24-month / 24,000-mile warranty</span
                    >. Get back on the road with confidence.
                </p>
            </div>
        </div>
    </div>

    <!-- CTA -->
    <div class="process-cta site-canvas">
        <CtaButton
            href="/request-an-appointment"
            text="Schedule Service"
            variant="standard"
        />
    </div>
</section>

<style>
    .process-section {
        --section-bg: #fafafa;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --accent: #0a79c8;
        --accent-light: rgba(10, 121, 200, 0.15);
        --dot-inactive: #e2e8f0;
        --line-color: #e2e8f0;

        background: var(--section-bg);
        padding: 6rem 0;
        position: relative;
        z-index: 10;
    }

    :global(.dark) .process-section {
        --section-bg: #0a0a0b;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --dot-inactive: rgba(255, 255, 255, 0.1);
        --line-color: rgba(255, 255, 255, 0.1);
    }

    /* Header */
    .process-header {
        text-align: center;
        margin-bottom: 4rem;
    }

    .process-badge {
        display: inline-block;
        font-size: 0.8125rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        color: var(--accent);
        margin-bottom: 1rem;
        text-transform: uppercase;
    }

    .process-title {
        color: var(--text-primary);
        margin: 0 0 1.5rem;
        line-height: 1;
    }

    .title-accent {
        color: var(--accent);
    }

    .process-subtitle {
        font-size: 1.125rem;
        color: var(--text-secondary);
        line-height: 1.7;
        max-width: 600px;
        margin: 0 auto;
    }

    /* Timeline Container */
    .timeline-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 1.5rem;
    }

    /* Timeline Item */
    .timeline-item {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
        opacity: 0;
        transform: translateY(40px);
    }

    .timeline-item:last-child {
        margin-bottom: 4rem;
    }

    /* Timeline Marker */
    .timeline-marker {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .timeline-dot {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--dot-inactive);
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        font-weight: 700;
        flex-shrink: 0;
        transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform: scale(0.8);
        opacity: 0;
    }

    .timeline-dot.active {
        background: var(--accent);
        color: #ffffff;
        transform: scale(1);
        opacity: 1;
        box-shadow: 0 0 0 8px var(--accent-light);
    }

    .timeline-line {
        width: 2px;
        flex: 1;
        background: var(--line-color);
        margin-top: 0.5rem;
        opacity: 0.5;
    }

    .timeline-item:last-child .timeline-line {
        display: none;
    }

    /* Timeline Content */
    .timeline-content {
        background: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: all 0.3s ease;
    }

    :global(.dark) .timeline-content {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.08);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .step-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.75rem;
    }

    .step-desc {
        font-size: 1rem;
        color: var(--text-secondary);
        line-height: 1.7;
        margin: 0;
    }

    .text-accent {
        color: var(--accent);
        font-weight: 600;
    }

    /* CTA */
    .process-cta {
        text-align: center;
        margin-top: 2rem;
    }

    /* Mobile */
    @media (max-width: 640px) {
        .timeline-container {
            padding: 0 1rem;
        }

        .timeline-item {
            grid-template-columns: 50px 1fr;
            gap: 1.5rem;
        }

        .timeline-dot {
            width: 50px;
            height: 50px;
            font-size: 1rem;
        }

        .step-title {
            font-size: 1.25rem;
        }

        .step-desc {
            font-size: 0.9375rem;
        }
    }
</style>

<script>
    import gsap from "gsap";

    let observer: IntersectionObserver | null = null;

    function initProcessTimeline() {
        // Cleanup existing observer
        if (observer) {
            observer.disconnect();
        }

        const section = document.getElementById("process-section");
        if (!section) return;

        const items = section.querySelectorAll(".timeline-item");
        if (items.length === 0) return;

        // IntersectionObserver for timeline items
        observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const item = entry.target as HTMLElement;
                        const dot = item.querySelector(".timeline-dot");

                        // Animate item
                        gsap.to(item, {
                            opacity: 1,
                            y: 0,
                            duration: 0.8,
                            ease: "power2.out",
                        });

                        // Animate dot with bounce
                        if (dot) {
                            gsap.to(dot, {
                                opacity: 1,
                                scale: 1,
                                duration: 0.6,
                                delay: 0.2,
                                ease: "back.out(1.7)",
                                onComplete: () => {
                                    dot.classList.add("active");
                                },
                            });
                        }

                        // Stop observing this item
                        observer?.unobserve(entry.target);
                    }
                });
            },
            {
                rootMargin: "0px 0px -25% 0px",
                threshold: 0.1,
            },
        );

        // Observe all items
        items.forEach((item) => observer?.observe(item));
    }

    document.addEventListener("astro:page-load", initProcessTimeline);

    document.addEventListener("astro:before-swap", () => {
        if (observer) {
            observer.disconnect();
            observer = null;
        }
    });
</script>
