---
interface Props {
    src: string;
    alt: string;
    class?: string;
    className?: string;
    aspectRatio?: string;
    loading?: "eager" | "lazy";
    direction?: "left" | "right" | "top" | "bottom"; // Reveal direction
}

const {
    src,
    alt,
    class: classStr = "",
    className = "",
    aspectRatio = "",
    loading = "lazy",
    direction = "right", // Default: reveal expanding from left to right
} = Astro.props;

// Combine custom classes
const wrapperClass =
    `image-reveal-wrapper group relative overflow-hidden block ${aspectRatio} ${classStr} ${className}`.trim();
---

<div class={wrapperClass} data-image-reveal data-reveal-direction={direction}>
    <img
        src={src}
        alt={alt}
        loading={loading}
        class="reveal-image block w-full h-full object-cover image-reveal-transition"
    />
</div>

<script>
    function getHiddenClipPath(direction: string): string {
        switch (direction) {
            case "left":
                return "inset(0 0 0 100%)";
            case "right":
                return "inset(0 100% 0 0)";
            case "top":
                return "inset(100% 0 0 0)";
            case "bottom":
                return "inset(0 0 100% 0)";
            default:
                return "inset(0 100% 0 0)";
        }
    }

    const setupRevealObserver = () => {
        const wrappers = document.querySelectorAll("[data-image-reveal]");

        // Progressive enhancement: JS sets the initial hidden state.
        // If JS fails, images are fully visible (no inline clip-path).
        wrappers.forEach((el) => {
            const wrapper = el as HTMLElement;
            const img = wrapper.querySelector(".reveal-image") as HTMLElement;
            const direction = wrapper.dataset.revealDirection || "right";

            if (img && !wrapper.dataset.revealReady) {
                // Mark as initialized so we don't re-hide on subsequent navigations
                wrapper.dataset.revealReady = "true";

                const rect = wrapper.getBoundingClientRect();
                const isInViewport =
                    rect.top < window.innerHeight && rect.bottom > 0;

                if (isInViewport) {
                    // Element is already visible in viewport (e.g., hero on navigation).
                    // Set hidden clip-path, then immediately transition to visible.
                    img.style.clipPath = getHiddenClipPath(direction);
                    // Force reflow so the transition animates
                    void img.offsetWidth;
                    img.style.clipPath = "inset(0 0 0 0)";
                } else {
                    // Element is below the fold â€” hide it and let IntersectionObserver trigger
                    img.style.clipPath = getHiddenClipPath(direction);
                }
            }
        });

        // Observer for off-screen elements
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const wrapper = entry.target as HTMLElement;
                        const img = wrapper.querySelector(
                            ".reveal-image",
                        ) as HTMLElement;
                        if (img) {
                            img.style.clipPath = "inset(0 0 0 0)";
                        }
                        observer.unobserve(wrapper);
                    }
                });
            },
            {
                root: null,
                rootMargin: "0px 0px -50px 0px",
                threshold: 0.1,
            },
        );

        // Only observe elements that weren't immediately revealed
        wrappers.forEach((el) => {
            const wrapper = el as HTMLElement;
            const img = wrapper.querySelector(".reveal-image") as HTMLElement;
            if (img && img.style.clipPath !== "inset(0 0 0 0)") {
                observer.observe(wrapper);
            }
        });
    };

    // Run on initial load
    setupRevealObserver();

    // Run on page navigation (View Transitions)
    document.addEventListener("astro:page-load", setupRevealObserver);
</script>

<style>
    /* Fallback for browsers that don't support clip-path well */
    @supports not (clip-path: inset(0)) {
        .reveal-image {
            clip-path: none !important;
            opacity: 1 !important;
        }
    }
</style>
