---
/**
 * ReviewsVideo - Video testimonial section with auto-looping review cards
 * Refactored with clean code to fix Chrome rendering issue
 * Mobile: Native Horizontal Scroll Carousel
 */

import reviews from "../data/reviews.json";

const getInitials = (name: string) =>
    name
        .split(" ")
        .map((w) => w[0])
        .join("")
        .substring(0, 2)
        .toUpperCase();

// logic: tripling the reviews for the infinite loop on desktop
// on mobile, we will hide the clones using CSS/JS
const allReviews = [...reviews, ...reviews, ...reviews];
const reviewCount = reviews.length;
const visibleCount = 2; // Number of cards visible at a time
---

<section
    class="rv-section pb-24 lg:pb-32 px-6 relative"
    data-visible-count={visibleCount}
    data-total-count={reviewCount}
>
    <!-- Background Decoration -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none opacity-20 dark:opacity-40">
        <div class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-queens-secondary/10 rounded-full blur-[120px]"></div>
        <div class="absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] bg-queens-primary/10 rounded-full blur-[120px]"></div>
    </div>

    <div class="rv-container max-w-7xl mx-auto relative z-10">
        <!-- Header -->
        <div class="text-center mb-12 lg:mb-20">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-queens-secondary/10 border border-queens-secondary/20 text-queens-secondary text-[10px] font-bold uppercase tracking-widest mb-4">
                <span class="w-1.5 h-1.5 rounded-full bg-queens-secondary animate-pulse"></span>
                Customer Success
            </div>
            <h2 class="rv-title display-xl mb-6">
                WORDS FROM OUR <span class="text-queens-secondary">CLIENTS</span
                >
            </h2>
            <p class="rv-subtitle text-lg max-w-2xl mx-auto opacity-80">
                Real reviews from real customers. Our commitment to quality
                service has earned us the trust of drivers across Elgin and surrounding areas.
            </p>
        </div>

        <!-- Content Grid -->
        <div class="rv-grid grid grid-cols-1 lg:grid-cols-12 gap-10 lg:gap-16 items-center">
            <!-- Left: Video Card (5 cols) -->
            <div class="lg:col-span-5 order-1 lg:order-1">
                <div
                    class="rv-video-card rounded-3xl overflow-hidden shadow-2xl aspect-[4/5] relative group"
                >
                    <video
                        autoplay
                        loop
                        muted
                        playsinline
                        poster="https://storage.googleapis.com/queens-videos/queenstestimonials.png"
                        style="background-image:url('https://storage.googleapis.com/queens-videos/queenstestimonials.png'); background-size: cover; background-position: center; clip-path: inset(0 0 100% 0);"
                        class="w-full h-full object-cover rv-video-reveal transition-transform duration-700 group-hover:scale-105"
                    >
                        <source
                            src="https://storage.googleapis.com/queens-videos/queenstestimonial.mp4"
                            type="video/mp4"
                        />
                        Your browser does not support the video tag.
                    </video>
                    
                    <!-- Overlay Decorations -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                    
                    <div
                        class="absolute top-6 left-6 right-6 flex justify-between items-center"
                    >
                        <div class="flex gap-0.5">
                           {[1,2,3,4,5].map(() => (
                               <span class="rv-star text-sm">★</span>
                           ))}
                        </div>
                        <span
                            class="bg-white/10 backdrop-blur-md text-white text-[10px] font-bold px-3 py-1.5 rounded-full border border-white/20"
                            >5.0 RATING</span
                        >
                    </div>
                    
                    <div class="absolute bottom-8 left-8 text-white">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-queens-secondary flex items-center justify-center font-bold text-sm">V</div>
                            <div>
                                <div class="font-bold text-lg leading-tight">Vanessa Roberts</div>
                                <div class="text-xs text-white/70 uppercase tracking-widest font-semibold">Elgin, IL</div>
                            </div>
                        </div>
                        <p class="text-sm text-white/90 italic leading-relaxed max-w-xs">
                            "The fastest service I've ever had in Elgin. They really care about their customers."
                        </p>
                    </div>

                    <!-- Play Button Visual -->
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="w-16 h-16 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center border border-white/30 group-hover:scale-110 transition-transform duration-500">
                             <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Review Cards (7 cols) -->
            <div class="lg:col-span-7 order-2 lg:order-2">
                <div class="relative">
                    <!-- Mobile Scroll Label -->
                    <div class="flex lg:hidden items-center justify-between mb-4">
                       <span class="text-[10px] font-bold tracking-[0.2em] text-queens-secondary uppercase">Swipe to read more</span>
                       <div class="flex gap-1">
                           <div class="w-8 h-[2px] bg-queens-secondary"></div>
                           <div class="w-4 h-[2px] bg-gray-300 dark:bg-gray-700"></div>
                       </div>
                    </div>

                    <div class="rv-carousel" id="rv-carousel">
                        <div class="rv-track flex flex-row lg:flex-col gap-5 lg:gap-6" id="rv-track">
                            {
                                allReviews.map((review, i) => (
                                    <div
                                        class={`rv-card rounded-[2rem] p-8 border flex flex-col justify-between transition-all duration-300 ${i >= reviewCount ? 'is-clone' : ''}`}
                                        data-index={i}
                                    >
                                        <div>
                                            <div class="flex gap-1 mb-6">
                                                {Array.from({
                                                    length: review.stars,
                                                }).map(() => (
                                                    <span class="rv-star text-lg">
                                                        ★
                                                    </span>
                                                ))}
                                            </div>
                                            <blockquote class="rv-quote text-lg lg:text-base leading-relaxed mb-8 italic">
                                                "{review.text}"
                                            </blockquote>
                                        </div>
                                        <div class="flex items-center gap-4 border-t border-gray-100 dark:border-white/5 pt-6">
                                            {review.image ? (
                                                <div class="relative">
                                                     <img
                                                        src={review.image}
                                                        alt={review.name}
                                                        class="w-12 h-12 rounded-full object-cover shadow-lg border-2 border-white dark:border-gray-800"
                                                    />
                                                    <div class="absolute -bottom-1 -right-1 bg-green-500 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-gray-800"></div>
                                                </div>
                                            ) : (
                                                <div class="rv-avatar w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg">
                                                    {getInitials(review.name)}
                                                </div>
                                            )}
                                            <div>
                                                <div class="rv-name font-bold text-base">
                                                    {review.name}
                                                </div>
                                                <div class="rv-role text-xs uppercase tracking-widest font-semibold opacity-60">
                                                    {review.role}
                                                </div>
                                            </div>
                                            <div class="ml-auto">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 opacity-10" fill="currentColor" viewBox="0 0 24 24"><path d="M14.017 21L14.017 18C14.017 16.8954 14.9124 16 16.017 16H19.017C19.5693 16 20.017 15.5523 20.017 15V9C20.017 8.44772 19.5693 8 19.017 8H16.017C14.9124 8 14.017 7.10457 14.017 6V3L20.017 3C21.1216 3 22.017 3.89543 22.017 5V15C22.017 18.3137 19.3307 21 16.017 21H14.017ZM3.0166 21L3.0166 18C3.0166 16.8954 3.91203 16 5.0166 16H8.0166C8.56889 16 9.0166 15.5523 9.0166 15V9C9.0166 8.44772 8.56889 8 8.0166 8H5.0166C3.91203 8 3.0166 7.10457 3.0166 6V3L9.0166 3C10.1212 3 11.0166 3.89543 11.0166 5V15C11.0166 18.3137 8.33031 21 5.0166 21H3.0166Z"/></svg>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                    
                    <!-- Fade effects for desktop -->
                    <div class="hidden lg:block absolute top-0 left-0 right-0 h-12 bg-gradient-to-b from-[#f5f5f5] dark:from-black to-transparent z-10 pointer-events-none"></div>
                    <div class="hidden lg:block absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-[#f5f5f5] dark:from-black to-transparent z-10 pointer-events-none"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    /* Star rating color */
    .rv-star {
        color: #facc15;
    }

    /* Light mode defaults */
    .rv-section {
        background-color: #f5f5f5;
        padding-top: 5rem; /* Reduced from 45vh to fix layout issues */
    }
    
    @media (min-width: 1024px) {
        .rv-section {
            padding-top: 10rem;
        }
    }

    .rv-title {
        color: #0f172a;
    }
    .rv-subtitle {
        color: #64748b;
    }
    .rv-card {
        background-color: #ffffff;
        border-color: rgba(0, 0, 0, 0.06);
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    }
    .rv-quote {
        color: #0f172a;
    }
    .rv-name {
        color: #0f172a;
    }
    .rv-role {
        color: #64748b;
    }
    .rv-avatar {
        background: linear-gradient(135deg, #0a79c8, #3b82f6);
    }

    /* Dark mode */
    :global(.dark) .rv-section {
        background-color: #000000;
    }
    :global(.dark) .rv-title {
        color: #f8fafc;
    }
    :global(.dark) .rv-subtitle {
        color: #94a3b8;
    }
    :global(.dark) .rv-card {
        background-color: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.08);
    }
    :global(.dark) .rv-quote {
        color: #f8fafc;
    }
    :global(.dark) .rv-name {
        color: #f8fafc;
    }
    :global(.dark) .rv-role {
        color: #94a3b8;
    }
    :global(.dark) .rv-avatar {
        background: linear-gradient(135deg, #22d3ee, #3b82f6);
    }

    /* Carousel container */
    .rv-carousel {
        overflow: hidden;
        height: 600px; /* Slightly taller for better readability */
    }

    /* Mobile: Native Horizontal Carousel */
    @media (max-width: 1023px) {
        .rv-carousel {
            height: auto;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px; /* Space for shadow */
            padding-right: 20px; /* Allow last card to be seen fully */
            margin: 0 -1.5rem; /* Negative margin to bleed to edges */
            padding-left: 1.5rem;
        }
        
        /* Hide scrollbar */
        .rv-carousel::-webkit-scrollbar {
            display: none;
        }
        .rv-carousel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .rv-track {
            transform: none !important;
            width: max-content;
            display: flex;
            flex-direction: row !important;
        }

        .rv-card {
            width: 85vw; /* The "Peek" effect: next card visible on right */
            max-width: 400px;
            scroll-snap-align: start;
            flex-shrink: 0;
            margin-right: 0;
            height: auto;
            min-height: 400px;
        }

        /* Hide cloned reviews on mobile to keep page length sane */
        .rv-card.is-clone {
            display: none !important;
        }

        .rv-video-card {
            max-width: 100%;
            margin: 0;
            aspect-ratio: 4 / 5;
        }
    }
    
    @media (min-width: 1024px) {
        .rv-card {
            min-height: 280px;
        }
    }
</style>

<script>
    import gsap from "gsap";

    let anim: gsap.core.Tween | null = null;

    function initCarousel() {
        if (anim) {
            anim.kill();
            anim = null;
        }

        // On mobile, we use native horizontal scroll, no GSAP loop needed
        if (window.innerWidth < 1024) {
            const track = document.getElementById("rv-track");
            if (track) {
                track.style.transform = "none";
            }
            return;
        }

        const section = document.querySelector(".rv-section");
        const carousel = document.getElementById("rv-carousel");
        const track = document.getElementById("rv-track");

        if (!section || !carousel || !track) return;

        const visibleCount = parseInt(
            section.getAttribute("data-visible-count") || "2",
            10,
        );
        const totalCount = parseInt(
            section.getAttribute("data-total-count") || "6",
            10,
        );
        
        // Only include non-cloned cards for calculation
        const cards = track.querySelectorAll(".rv-card:not(.is-clone)");
        if (cards.length === 0) return;

        const card = cards[0] as HTMLElement;
        const cardH = card.offsetHeight;
        const gap = parseFloat(getComputedStyle(track).gap) || 24;
        
        // Calculate visible height
        const setH = cardH * 2 + gap; // Force 2 cards height
        const scrollDistance = (cardH + gap) * totalCount;

        carousel.style.height = `${setH}px`;

        anim = gsap.to(track, {
            y: -scrollDistance,
            duration: 25, // Slower for better readability
            ease: "none",
            repeat: -1,
            modifiers: {
                y: gsap.utils.unitize(
                    gsap.utils.wrap(0, -scrollDistance),
                ),
            },
        });

        carousel.addEventListener("mouseenter", () => anim?.pause());
        carousel.addEventListener("mouseleave", () => anim?.resume());
    }

    // Separate function for entry animations
    function initReviewsEntryAnimations() {
        const section = document.querySelector(".rv-section");
        if (!section) return;

        // Import ScrollTrigger if not registered
        import("gsap/ScrollTrigger").then(({ ScrollTrigger }) => {
            gsap.registerPlugin(ScrollTrigger);

            // Header elements
            const badge = section.querySelector(".inline-flex");
            const title = section.querySelector(".rv-title");
            const subtitle = section.querySelector(".rv-subtitle");
            const headerElements = [badge, title, subtitle].filter(Boolean);

            if (headerElements.length > 0) {
                gsap.fromTo(
                    headerElements,
                    { y: 30, opacity: 0 },
                    {
                        y: 0,
                        opacity: 1,
                        stagger: 0.1,
                        duration: 0.8,
                        ease: "power3.out",
                        scrollTrigger: {
                            trigger: section,
                            start: "top 70%",
                            once: true,
                        },
                    },
                );
            }

            // Video card container
            const videoCard = section.querySelector(".rv-video-card");
            if (videoCard) {
                gsap.fromTo(
                    videoCard,
                    { opacity: 0, x: -30 },
                    {
                        opacity: 1,
                        x: 0,
                        duration: 1,
                        ease: "power3.out",
                        scrollTrigger: {
                            trigger: section,
                            start: "top 60%",
                            once: true,
                        },
                    },
                );
            }

            // Carousel container
            const carouselContainer = document.getElementById("rv-carousel");
            if (carouselContainer) {
                gsap.fromTo(
                    carouselContainer,
                    { x: 30, opacity: 0 },
                    {
                        x: 0,
                        opacity: 1,
                        duration: 1,
                        ease: "power3.out",
                        scrollTrigger: {
                            trigger: section,
                            start: "top 50%",
                            once: true,
                        },
                    },
                );
            }

            // Video reveal (roll down effect)
            const reviewVideo = section.querySelector(".rv-video-reveal");
            const videoCardTrigger = section.querySelector(".rv-video-card");

            if (reviewVideo && videoCardTrigger) {
                gsap.to(reviewVideo, {
                    clipPath: "inset(0 0 0% 0)",
                    duration: 1.5,
                    ease: "power4.out",
                    scrollTrigger: {
                        trigger: videoCardTrigger,
                        start: "top 70%",
                        once: true,
                    },
                });
            }
        });
    }

    document.addEventListener("astro:page-load", () => {
        initCarousel();
        setTimeout(initReviewsEntryAnimations, 200);
    });

    if (document.readyState !== "loading") {
        initCarousel();
    } else {
        document.addEventListener("DOMContentLoaded", initCarousel);
    }

    document.addEventListener("astro:before-swap", () => {
        if (anim) {
            anim.kill();
            anim = null;
        }
    });

    let rT: ReturnType<typeof setTimeout>;
    window.addEventListener("resize", () => {
        clearTimeout(rT);
        rT = setTimeout(initCarousel, 250);
    });

    // Edge/browser autoplay fallback
    function forceVideoPlay() {
        document.querySelectorAll("video").forEach((video) => {
            video.play().catch(() => {});
        });
    }

    document.addEventListener("astro:page-load", forceVideoPlay);
    if (document.readyState !== "loading") {
        forceVideoPlay();
    } else {
        document.addEventListener("DOMContentLoaded", forceVideoPlay);
    }
</script>

