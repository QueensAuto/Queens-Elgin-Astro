---
import type { BrandConfig } from "../brands";
import { mobileTiresBrand } from "../brands";

const { brand = mobileTiresBrand } = Astro.props as { brand?: BrandConfig };
const phoneDigits = brand.phone.replace(/\D/g, "");
---

<div
  id="mobile-phone-bubble"
  class="mobile-phone-bubble fixed left-4 z-[70] flex items-center gap-2 transition-all duration-200 md:hidden"
>
  <a
    href={`tel:${phoneDigits}`}
    class="pointer-events-auto flex h-14 w-14 items-center justify-center rounded-full bg-[var(--color-queens-primary)] text-white shadow-lg transition-transform duration-200 hover:scale-105 focus-visible:scale-105 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--color-queens-primary)]"
    aria-label={`Call us at ${brand.phone}`}
  >
    <svg
      class="h-6 w-6 text-white"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
      ></path>
    </svg>
  </a>

  <span
    class="mobile-phone-bubble-label rounded-full px-4 py-2 text-sm font-semibold shadow-lg"
  >
    Call Us
  </span>
</div>

<script>
  function initMobilePhoneBubble() {
    const globalWindow = window as Window & {
      __mobilePhoneBubbleScrollHandler?: () => void;
    };
    const bubble = document.getElementById("mobile-phone-bubble");
    if (!bubble) return;

    const SCROLL_DELTA_THRESHOLD = 4;
    const TOP_HIDE_THRESHOLD = 20;

    const showBubble = () => bubble.classList.add("is-visible");
    const hideBubble = () => bubble.classList.remove("is-visible");

    let lastScrollY = window.scrollY;
    let ticking = false;

    const updateVisibility = () => {
      const currentScrollY = window.scrollY;
      const hasScrolledDown =
        currentScrollY > lastScrollY + SCROLL_DELTA_THRESHOLD;
      const hasScrolledUp =
        currentScrollY < lastScrollY - SCROLL_DELTA_THRESHOLD;

      if (currentScrollY <= TOP_HIDE_THRESHOLD || hasScrolledUp) {
        hideBubble();
      } else if (hasScrolledDown) {
        showBubble();
      }

      lastScrollY = currentScrollY;
      ticking = false;
    };

    if (globalWindow.__mobilePhoneBubbleScrollHandler) {
      window.removeEventListener(
        "scroll",
        globalWindow.__mobilePhoneBubbleScrollHandler,
      );
    }

    globalWindow.__mobilePhoneBubbleScrollHandler = () => {
      if (!ticking) {
        window.requestAnimationFrame(updateVisibility);
        ticking = true;
      }
    };

    window.addEventListener(
      "scroll",
      globalWindow.__mobilePhoneBubbleScrollHandler,
      {
        passive: true,
      },
    );

    hideBubble();
  }

  initMobilePhoneBubble();
  document.addEventListener("astro:page-load", initMobilePhoneBubble);
</script>

<style>
  .mobile-phone-bubble {
    bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
    opacity: 0;
    transform: translateY(1rem);
    pointer-events: none;
  }

  .mobile-phone-bubble.is-visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .mobile-phone-bubble-label {
    background-color: #ffffff !important;
    color: #0b1121 !important;
  }
</style>
