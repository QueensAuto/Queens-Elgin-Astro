---
/**
 * Schema.astro
 * Centralized JSON-LD Schema Generator for Queens Auto Service
 */
import type { BrandConfig } from "../../brands/types";

interface Props {
    brand: BrandConfig;
    type?: "LocalBusiness" | "Service" | "FAQPage" | "WebSite";
    pageType?: string;
    title?: string;
    description?: string;
    url?: string;
    image?: string;
    serviceData?: any;
    faqData?: any;
    reviewData?: any[];
}

const {
    brand,
    type = "LocalBusiness",
    title,
    description,
    url,
    image,
    serviceData,
    faqData,
    reviewData,
} = Astro.props;

const canonicalUrl = url || `https://${brand.domain}${Astro.url.pathname}`;
const siteName = brand.name;

// 1. Base Organization / LocalBusiness Schema
const localBusinessSchema = {
    "@context": "https://schema.org",
    "@type": "AutoRepair",
    "@id": `https://${brand.domain}/#organization`,
    name: brand.name,
    url: `https://${brand.domain}`,
    logo: {
        "@type": "ImageObject",
        url: `https://${brand.domain}${brand.logoPath}`,
        width: "512",
        height: "512",
    },
    image:
        image ||
        (brand.shopImage
            ? `https://${brand.domain}${brand.shopImage}`
            : `https://${brand.domain}/images/shop/Queens-Auto-Services-Elgin-a-view-from-outside.webp`),
    telephone: brand.phone,
    email: brand.email,
    address: {
        "@type": "PostalAddress",
        streetAddress: brand.streetAddress || "1303 Dundee Ave",
        addressLocality: brand.addressLocality || "Elgin",
        addressRegion: brand.addressRegion || "IL",
        postalCode: brand.postalCode || "60120",
        addressCountry: "US",
    },
    geo: {
        "@type": "GeoCoordinates",
        latitude: brand.latitude || 42.0615014,
        longitude: brand.longitude || -88.2652443,
    },
    hasMap: brand.googleMapsUrl,
    openingHoursSpecification: [
        {
            "@type": "OpeningHoursSpecification",
            dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            opens: "07:30",
            closes: "18:00",
        },
        {
            "@type": "OpeningHoursSpecification",
            dayOfWeek: "Saturday",
            opens: "07:30",
            closes: "16:00",
        },
    ],
    sameAs: [
        "https://www.facebook.com/queensautoservice/",
        "https://www.instagram.com/queensautoservice/",
    ],
    priceRange: "$$",
    aggregateRating: {
        "@type": "AggregateRating",
        ratingValue: brand.ratingValue || "4.5",
        reviewCount: brand.reviewCount || "489",
    },
};

// 2. WebSite Schema (Search Box)
const websiteSchema = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "@id": `https://${brand.domain}/#website`,
    url: `https://${brand.domain}`,
    name: siteName,
    publisher: {
        "@id": `https://${brand.domain}/#organization`,
    },
    potentialAction: {
        "@type": "SearchAction",
        target: `https://${brand.domain}/search?q={search_term_string}`,
        "query-input": "required name=search_term_string",
    },
};

// 3. Service Schema (For individual service pages)
let serviceSchema = null;
if (serviceData) {
    serviceSchema = {
        "@context": "https://schema.org",
        "@type": "Service",
        serviceType: serviceData.title,
        provider: {
            "@id": `https://${brand.domain}/#organization`,
        },
        areaServed: [
            {
                "@type": "City",
                name: "Elgin",
                sameAs: "https://en.wikipedia.org/wiki/Elgin,_Illinois",
            },
            {
                "@type": "City",
                name: "South Elgin",
                sameAs: "https://en.wikipedia.org/wiki/South_Elgin,_Illinois",
            },
            {
                "@type": "City",
                name: "Hoffman Estates",
                sameAs: "https://en.wikipedia.org/wiki/Hoffman_Estates,_Illinois",
            },
        ],
        description: serviceData.pitch || description,
        offers: {
            "@type": "Offer",
            availability: "https://schema.org/InStock",
            url: canonicalUrl,
        },
    };
}

// 4. FAQ Schema
let faqSchema = null;
if (faqData) {
    faqSchema = {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: faqData.map((faq: any) => ({
            "@type": "Question",
            name: faq.question,
            acceptedAnswer: {
                "@type": "Answer",
                text: faq.answer,
            },
        })),
    };
}
// 5. Review Schema
let reviewSchema = null;
if (reviewData && reviewData.length > 0) {
    reviewSchema = reviewData.map((review: any) => ({
        "@context": "https://schema.org",
        "@type": "Review",
        itemReviewed: {
            "@id": `https://${brand.domain}/#organization`,
        },
        reviewRating: {
            "@type": "Rating",
            ratingValue: review.stars.toString(),
            bestRating: "5",
        },
        author: {
            "@type": "Person",
            name: review.name,
        },
        reviewBody: review.text,
        publisher: {
            "@id": `https://${brand.domain}/#organization`,
        },
    }));
}

// 6. Breadcrumb Schema
const pathSegments = Astro.url.pathname.split("/").filter(Boolean);
const breadcrumbList = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: `https://${brand.domain}`,
        },
        ...pathSegments.map((segment, index) => ({
            "@type": "ListItem",
            position: index + 2,
            name:
                segment.charAt(0).toUpperCase() +
                segment.slice(1).replace(/-/g, " "),
            item: `https://${brand.domain}/${pathSegments.slice(0, index + 1).join("/")}`,
        })),
    ],
};
---

{/* Inject Global Schemas on Every Page */}
<script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(localBusinessSchema)}
/>
<script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(websiteSchema)}
/>
<script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(breadcrumbList)}
/>

{/* Conditional Schemas */}
{
    serviceSchema && (
        <script
            is:inline
            type="application/ld+json"
            set:html={JSON.stringify(serviceSchema)}
        />
    )
}
{
    faqSchema && (
        <script
            is:inline
            type="application/ld+json"
            set:html={JSON.stringify(faqSchema)}
        />
    )
}
{
    reviewSchema &&
        reviewSchema.map((review: any) => (
            <script
                is:inline
                type="application/ld+json"
                set:html={JSON.stringify(review)}
            />
        ))
}
